\documentclass{article}
\usepackage{longtable}
\usepackage{colortbl}

\begin{document}

\VAR{full_number} Проверка переключения режимов работы БУФ: \VAR{h.add_background_color(h.exist_result(step_status))}.

%% if step_status == 'Passed' or step_status == 'Failed'
    %% set prec = 1
    %% set prec1 = 2

    %% set temp = []

    %% set Check_TM_test = []

    %% set AB1_on_current_KPA_limits = []
    %% set AB2_on_current_KPA_limits = []
    %% set AB1_off_current_KPA_limits = []
    %% set AB2_off_current_KPA_limits = []

    %% set AB1_on_current_TM_limits = []
    %% set AB2_on_current_TM_limits = []
    %% set AB1_off_current_TM_limits = []
    %% set AB2_off_current_TM_limits = []
    %% set Check_Total_CC_on_Batteries_limits = []

    %% set On_SHPP_KPA_current_limits = []
    %% set On_SHPP_TM_current_limits = []
    %% set Off_SHPP_KPA_current_limits = []
    %% set Off_SHPP_TM_current_limits = []
    %% set On_SHPP_TM_voltage_exists = []
    %% set Off_SHPP_TM_voltage_exists = []

    %% set On_KSU_KPA_voltage_limits = []
    %% set Off_KSU_KPA_voltage_limits = []
    %% set On_KSU_TM_voltage_limits = []
    %% set Off_KSU_TM_voltage_limits = []

    %% set substeps = e.get_substeps(step, 'SequenceCall', 'Main')

    %% for substep in substeps
        %% set substeps_NumericLimitTest = e.get_substeps(substep, 'NumericLimitTest', 'Main')

        %% set _ = AB1_off_current_KPA_limits.extend(e.get_test_status_by_name(substeps_NumericLimitTest, 'Check Current Battery 1 KPA Charge Off'))
        %% set _ = AB2_off_current_KPA_limits.extend(e.get_test_status_by_name(substeps_NumericLimitTest, 'Check Current Battery 2 KPA Charge Off'))
        %% set _ = AB1_off_current_TM_limits.extend(e.get_test_status_by_name(substeps_NumericLimitTest, 'Check Current Battery 1 TM Charge Off'))
        %% set _ = AB2_off_current_TM_limits.extend(e.get_test_status_by_name(substeps_NumericLimitTest, 'Check Current Battery 2 TM Charge Off'))

        %% for substep in substeps_NumericLimitTest
            % табл 2
            %% if e.get_numeric_limits([substep], 'Check Current Battery 1 KPA Charge On', 'Numeric')
            %% set dump = AB1_on_current_KPA_limits.append(e.get_numeric_limits([substep], 'Check Current Battery 1 KPA Charge On', 'Numeric'))
            %% elif e.get_numeric_limits([substep], 'Check Current Battery 2 KPA Charge On', 'Numeric')
            %% set dump = AB2_on_current_KPA_limits.append(e.get_numeric_limits([substep], 'Check Current Battery 2 KPA Charge On', 'Numeric'))
            %% elif e.get_numeric_limits([substep], 'Check Current Battery 1 TM Charge On', 'Numeric')
            %% set dump = AB1_on_current_TM_limits.append(e.get_numeric_limits([substep], 'Check Current Battery 1 TM Charge On', 'Numeric'))
            %% elif e.get_numeric_limits([substep], 'Check Current Battery 2 TM Charge On', 'Numeric')
            %% set dump = AB2_on_current_TM_limits.append(e.get_numeric_limits([substep], 'Check Current Battery 2 TM Charge On', 'Numeric'))
            % ... остальные условия ...
        %% endfor
    %% endfor

    % Далее продолжите ваш шаблон аналогично вашему оригинальному файлу, вставляя переменные и условные операторы Jinja2 в нужные места.

\end{document}
